name: Daily Content Cycle

on:
  push:
    branches: [ master ]
  schedule:
    # Run every 6 hours (7 AM, 1 PM, 7 PM, 1 AM)
    - cron: '0 7,13,19,1 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  daily-cycle:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run Daily Cycle (Fetch & Generate)
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/run_daily_cycle.py
        
      - name: Prepare & Post Today's Content
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: python scripts/prepare_todays_posts.py
        
      - name: Commit changes (Queue & Logs)
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ¤– Daily content cycle update [skip ci]"
          file_pattern: "data/*"
